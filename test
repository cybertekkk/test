import streamlit as st
import pandas as pd
import json
import os
import glob
from datetime import datetime

# --- Page Config ---
st.set_page_config(
    page_title="Enterprise DQ Dashboard",
    page_icon="ðŸ“Š",
    layout="wide",
    initial_sidebar_state="expanded",
)

# --- Custom Styling ---
st.markdown("""
    <style>
    .main {
        background-color: #0f172a;
    }
    .stMetric {
        background-color: #1e293b;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #334155;
    }
    .status-pass {
        color: #10b981;
        font-weight: bold;
    }
    .status-fail {
        color: #ef4444;
        font-weight: bold;
    }
    </style>
    """, unsafe_allow_html=True)

def load_results(directory="artifacts"):
    """Loads all JSON result files recursively from the artifacts directory."""
    files = glob.glob(os.path.join(directory, "**/*.json"), recursive=True)
    all_data = []
    for f in files:
        try:
            with open(f, 'r') as file:
                data = json.load(file)
                data['filename'] = os.path.basename(f)
                all_data.append(data)
        except Exception as e:
            st.error(f"Error loading {f}: {e}")
    return all_data

# --- Sidebar ---
st.sidebar.title("ðŸ” DQ Explorer")
st.sidebar.markdown("---")

results = load_results()

if not results:
    st.title("ðŸ“Š Data Quality Dashboard")
    st.warning("No DQ results found. Please run the validation engine first.")
    st.info("Results should be located in the `artifacts/` folder as JSON files.")
else:
    # Sort results by timestamp (newest first)
    results.sort(key=lambda x: x.get('timestamp', ''), reverse=True)
    
    # 1. Select Suite
    suite_names = sorted(list(set(r['suite_name'] for r in results)))
    selected_suite = st.sidebar.selectbox("Select Test Suite", suite_names)
    
    # Filter results for selected suite
    suite_results = [r for r in results if r['suite_name'] == selected_suite]
    
    # 2. Select Run (Timestamp)
    run_labels = [datetime.fromisoformat(r['timestamp']).strftime("%Y-%m-%d %H:%M:%S") for r in suite_results]
    selected_run_idx = st.sidebar.selectbox("Select Execution Run", range(len(run_labels)), format_func=lambda x: run_labels[x])
    
    data = suite_results[selected_run_idx]
    
    # --- Main Dashboard ---
    st.title(f"ðŸ“Š DQ Dashboard: {data['suite_name']}")
    st.markdown(f"**Run Timestamp:** `{run_labels[selected_run_idx]}`")
    
    # Metrics
    m1, m2, m3, m4 = st.columns(4)
    summary = data['summary']
    pass_rate = (summary['passed'] / summary['total'] * 100) if summary['total'] > 0 else 0
    
    m1.metric("Total Checks", summary['total'])
    m2.metric("Passed", summary['passed'], delta=None)
    m3.metric("Failed", summary['failed'], delta=None, delta_color="inverse")
    m4.metric("Success Rate", f"{pass_rate:.1f}%")

    # Tabs for different validation types
    tab1, tab2 = st.tabs(["ðŸ“Š SQL Business Checks", "ðŸ›¡ GE Integrity Checks"])
    
    with tab1:
        if data.get('sql_validations'):
            sql_df = pd.DataFrame(data['sql_validations'])
            
            # Format display
            display_df = sql_df[['id', 'name', 'status', 'found_rows', 'expected_result']].copy()
            
            def style_status(val):
                color = '#10b981' if val == 'PASSED' else '#ef4444'
                return f'color: {color}; font-weight: bold'

            st.dataframe(
                display_df.style.applymap(style_status, subset=['status']),
                use_container_width=True,
                hide_index=True
            )
            
            # Detailed View for Failures
            st.subheader("Failure Details")
            failures = [v for v in data['sql_validations'] if v['status'] != 'PASSED']
            if failures:
                for fail in failures:
                    with st.expander(f"âŒ {fail['id']}: {fail['name']}"):
                        st.markdown(f"**Scenario:** {fail['scenario']}")
                        st.markdown(f"**Query:**")
                        st.code(fail['query'], language='sql')
                        if fail.get('sample_data'):
                            st.markdown("**Sample Failing Rows (Head 5):**")
                            st.table(pd.DataFrame(fail['sample_data']))
            else:
                st.success("All SQL checks passed!")
        else:
            st.info("No SQL business checks in this suite.")

    with tab2:
        if data.get('ge_validations'):
            ge_list = []
            for v in data['ge_validations']:
                ge_list.append({
                    "Expectation": v['expectation'],
                    "Column": v['params'].get('column', v['params'].get('column_a', 'N/A')),
                    "Status": v['status']
                })
            
            ge_df = pd.DataFrame(ge_list)
            st.dataframe(
                ge_df.style.applymap(style_status, subset=['Status']),
                use_container_width=True,
                hide_index=True
            )
        else:
            st.info("No Great Expectations checks in this suite.")

st.sidebar.markdown("---")
st.sidebar.caption("Enterprise Data Quality Framework v1.0")

---------->>>>>>>>>> dashboard.py



------->>> validation_engine.py

import datetime
import json
import decimal
import os
from loguru import logger
from great_expectations.dataset import PandasDataset

class ValidationEngine:
    def __init__(self, db_adapter, output_dir: str = "artifacts"):
        self.db_adapter = db_adapter
        self.output_dir = output_dir
        if not os.path.exists(self.output_dir):
            os.makedirs(self.output_dir)

    def run_full_validation(self, config: dict):
        suite_name = config.get('suite_name', 'default_suite')
        logger.info(f"Starting Validation for: {suite_name}")
        
        overall_results = {
            "suite_name": suite_name,
            "timestamp": datetime.datetime.now().isoformat(),
            "ge_validations": [],
            "sql_validations": [],
            "summary": {"total": 0, "passed": 0, "failed": 0}
        }

        if 'sql_checks' in config:
            self._run_sql_checks(config['sql_checks'], overall_results)

        if 'query' in config and 'expectations' in config:
            try:
                df = self.db_adapter.fetch_data(config['query'])
                self._run_ge_checks(df, config['expectations'], overall_results)
            except Exception as e:
                logger.error(f"Failed to fetch data or run GE checks: {e}")

        self._save_artifacts(suite_name, overall_results)
        return overall_results

    def _run_sql_checks(self, sql_checks: list, overall_results: dict):
        logger.info("Running SQL business logic validation checks...")
        for check in sql_checks:
            check_id = check.get('id', 'N/A')
            name = check['name']
            query = check['query']
            expected_count = check.get('expected_count', 0)
            
            logger.info(f"Executing SQL check {check_id}: {name}")
            try:
                df = self.db_adapter.fetch_data(query)
                
                # If query returns a single value (e.g. SELECT COUNT(*)), interpret that value as the count.
                # Otherwise, use the total number of rows returned.
                if df.shape == (1, 1):
                    try:
                        actual_count = int(df.iloc[0, 0])
                    except (ValueError, TypeError):
                        actual_count = len(df)
                else:
                    actual_count = len(df)

                # Status is PASSED if the count is within threshold OR if the result is exactly 0
                status = "PASSED" if (actual_count <= expected_count or actual_count == 0) else "FAILED"
            except Exception as e:
                logger.error(f"SQL Execution failed for {name}: {e}")
                status = "ERROR"
                actual_count = -1
                df = None

            overall_results["summary"]["total"] += 1
            if status == "PASSED":
                overall_results["summary"]["passed"] += 1
            else:
                overall_results["summary"]["failed"] += 1

            overall_results["sql_validations"].append({
                "id": check_id,
                "name": name,
                "objective": check.get('objective', ''),
                "scenario": check.get('scenario', ''),
                "expected_result": check.get('expected_result', ''),
                "query": query,
                "status": status,
                "found_rows": actual_count,
                "sample_data": df.head(5).to_dict(orient='records') if (status == "FAILED" and df is not None and not df.empty) else []
            })

    def _run_ge_checks(self, df, expectations: list, overall_results: dict):
        logger.info("Running Great Expectations data integrity checks...")
        df.columns = [c.upper() for c in df.columns]
        ge_df = PandasDataset(df)
        for check in expectations:
            method_name = check['type']
            params = check['params'].copy()
            if 'column' in params and isinstance(params['column'], str): params['column'] = params['column'].upper()
            if 'columns' in params and isinstance(params['columns'], list): params['columns'] = [c.upper() for c in params['columns']]

            # -- CUSTOM COMPLEX CHECKS --
            if method_name == "custom_check_composite_uniqueness":
                try:
                    cols = params['columns']
                    temp_col = "_composite_key"
                    ge_df[temp_col] = ge_df[cols].astype(str).agg('-'.join, axis=1)
                    res = ge_df.expect_column_values_to_be_unique(temp_col)
                    status = "PASSED" if res['success'] else "FAILED"
                    res_dict = res.to_json_dict()
                except Exception as e:
                    logger.error(f"Custom uniqueness validation failed: {e}")
                    status = "ERROR"; res_dict = {"success": False, "exception": str(e)}

            elif method_name == "custom_expect_column_a_to_be_less_than_b":
                try:
                    col_a, col_b = params['column_a'].upper(), params['column_b'].upper()
                    # Boolean series where A < B
                    success_series = ge_df[col_a] < ge_df[col_b] 
                    success = success_series.all()
                    status = "PASSED" if success else "FAILED"
                    res_dict = {"success": success, "unexpected_count": len(ge_df[~success_series])}
                except Exception as e:
                    status = "ERROR"; res_dict = {"success": False, "exception": str(e)}

            elif method_name == "custom_expect_date_sequence_valid":
                try:
                    start_col, end_col = params['start_column'].upper(), params['end_column'].upper()
                    ge_df[start_col] = pd.to_datetime(ge_df[start_col])
                    ge_df[end_col] = pd.to_datetime(ge_df[end_col])
                    success_series = ge_df[start_col] <= ge_df[end_col]
                    success = success_series.all()
                    status = "PASSED" if success else "FAILED"
                    res_dict = {"success": success, "unexpected_count": len(ge_df[~success_series])}
                except Exception as e:
                    status = "ERROR"; res_dict = {"success": False, "exception": str(e)}

            elif method_name == "custom_expect_column_b_if_a":
                try:
                    # Logic: If col_a == val_a, then col_b must == val_b
                    col_a = params['column_a'].upper()
                    val_a = params['value_a']
                    col_b = params['column_b'].upper()
                    val_b = params.get('expected_value_b', True)
                    
                    # Check rows where A matches val_a
                    relevant_rows = ge_df[ge_df[col_a] == val_a]
                    if relevant_rows.empty:
                        success = True
                        unexpected_count = 0
                    else:
                        # Compare against expected value B
                        success_series = relevant_rows[col_b] == val_b
                        success = success_series.all()
                        unexpected_count = len(relevant_rows[~success_series])
                        
                    status = "PASSED" if success else "FAILED"
                    res_dict = {"success": success, "unexpected_count": unexpected_count}
                except Exception as e:
                    status = "ERROR"; res_dict = {"success": False, "exception": str(e)}

            # -- STANDARD GREAT EXPECTATIONS CHECKS --
            elif hasattr(ge_df, method_name):
                try:
                    res = getattr(ge_df, method_name)(**params)
                    status = "PASSED" if res['success'] else "FAILED"
                    res_dict = res.to_json_dict()
                except Exception as e:
                    logger.error(f"Expectation {method_name} failed: {e}")
                    status = "ERROR"; res_dict = {"success": False, "exception": str(e)}
            else:
                logger.warning(f"Expectation type '{method_name}' not found.")
                continue

            overall_results["summary"]["total"] += 1
            if status == "PASSED": overall_results["summary"]["passed"] += 1
            else: overall_results["summary"]["failed"] += 1
                
            overall_results["ge_validations"].append({
                "expectation": method_name, "params": params, "status": status, "result": res_dict
            })

    def _save_artifacts(self, suite_name: str, results: dict):
        ts = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
        
        # Create suite-specific directory
        suite_dir = os.path.join(self.output_dir, suite_name)
        if not os.path.exists(suite_dir):
            os.makedirs(suite_dir)
            
        class CustomJSONEncoder(json.JSONEncoder):
            def default(self, obj):
                if isinstance(obj, (datetime.date, datetime.datetime)):
                    return obj.isoformat()
                if isinstance(obj, decimal.Decimal):
                    return float(obj)
                return super().default(obj)

        # 1. JSON Data
        json_path = os.path.join(suite_dir, f"{suite_name}_{ts}.json")
        with open(json_path, 'w') as f: json.dump(results, f, indent=4, cls=CustomJSONEncoder)
        
        # 2. Markdown Report
        md_path = os.path.join(suite_dir, f"{suite_name}_{ts}_report.md")
        self._write_markdown(md_path, suite_name, results)

        # 3. HTML Premium Report
        html_path = os.path.join(suite_dir, f"{suite_name}_{ts}_report.html")
        self._write_html(html_path, suite_name, results)

        logger.info(f"Artifacts saved in {suite_dir}: JSON, MD, and Premium HTML Report")

    def _write_markdown(self, path, suite_name, results):
        with open(path, 'w') as f:
            f.write(f"# DQ Report: {suite_name}\n\n")
            f.write(f"Summary: {results['summary']['passed']}/{results['summary']['total']} Passed\n\n")
            if results['sql_validations']:
                f.write("| Test ID | Scenario | Expected | Status |\n| --- | --- | --- | --- |\n")
                for v in results['sql_validations']:
                    f.write(f"| {v['id']} | {v['scenario']} | {v['expected_result']} | {v['status']} |\n")

    def _write_html(self, path, suite_name, results):
        status_color = "#10b981" if results['summary']['failed'] == 0 else "#ef4444"
        
        sql_rows = ""
        for v in results['sql_validations']:
            badge_class = "pass" if v['status'] == "PASSED" else "fail"
            sql_rows += f"""
            <tr>
                <td><span class="id-tag">{v['id']}</span></td>
                <td><strong>{v['name']}</strong><br><small>{v['scenario']}</small></td>
                <td>{v['objective']}</td>
                <td><span class="badge {badge_class}">{v['status']}</span></td>
            </tr>
            """

        ge_rows = ""
        for v in results['ge_validations']:
            badge_class = "pass" if v['status'] == "PASSED" else "fail"
            ge_rows += f"""
            <tr>
                <td>{v['expectation']}</td>
                <td><code style="font-size: 0.8em;">{json.dumps(v['params'])}</code></td>
                <td><span class="badge {badge_class}">{v['status']}</span></td>
            </tr>
            """

        html_content = f"""
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>DQ Report | {suite_name}</title>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
            <style>
                :root {{ --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #10b981; --danger: #ef4444; }}
                body {{ font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 40px; line-height: 1.6; }}
                .container {{ max-width: 1100px; margin: 0 auto; }}
                .header {{ display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid #334155; padding-bottom: 20px; }}
                h1 {{ margin: 0; font-size: 2rem; background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }}
                .summary-cards {{ display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }}
                .card {{ background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }}
                .card p {{ margin: 0; font-size: 0.9rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }}
                .card h2 {{ margin: 10px 0 0 0; font-size: 2.5rem; }}
                table {{ width: 100%; border-collapse: separate; border-spacing: 0; background: var(--card); border-radius: 16px; overflow: hidden; border: 1px solid #334155; margin-bottom: 40px; }}
                th, td {{ padding: 18px 24px; text-align: left; border-bottom: 1px solid #334155; }}
                th {{ background: #334155; color: #94a3b8; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }}
                tr:last-child td {{ border-bottom: none; }}
                .badge {{ padding: 6px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }}
                .badge.pass {{ background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid var(--success); }}
                .badge.fail {{ background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }}
                .id-tag {{ background: #475569; padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; }}
                .section-title {{ display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: #94a3b8; font-size: 1.2rem; font-weight: 600; }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <div>
                        <h1>Enterprise DQ Report</h1>
                        <p style="color: #64748b; margin-top: 5px;">Suite: {suite_name} | {results['timestamp']}</p>
                    </div>
                    <div class="badge { 'pass' if results['summary']['failed'] == 0 else 'fail' }" style="font-size: 1rem; padding: 10px 20px;">
                        { 'STABLE' if results['summary']['failed'] == 0 else 'ACTION REQUIRED' }
                    </div>
                </div>

                <div class="summary-cards">
                    <div class="card"><p>Total Checks</p><h2>{results['summary']['total']}</h2></div>
                    <div class="card" style="border-left: 4px solid var(--success);"><p>Passed</p><h2 style="color: var(--success);">{results['summary']['passed']}</h2></div>
                    <div class="card" style="border-left: 4px solid var(--danger);"><p>Failed</p><h2 style="color: var(--danger);">{results['summary']['failed']}</h2></div>
                </div>

                <div class="section-title">ðŸ“Š SQL Business Logic Assertions</div>
                <table>
                    <thead><tr><th>ID</th><th>Test Scenario</th><th>Objective</th><th>Status</th></tr></thead>
                    <tbody>{sql_rows}</tbody>
                </table>

                { f'<div class="section-title">ðŸ›¡ Data Integrity (Great Expectations)</div>' if ge_rows else '' }
                { f'<table><thead><tr><th>Expectation</th><th>Params</th><th>Status</th></tr></thead><tbody>{ge_rows}</tbody></table>' if ge_rows else '' }
            </div>
        </body>
        </html>
        """
        with open(path, 'w') as f: f.write(html_content)


