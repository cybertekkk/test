describe('GitLab Project Lifecycle Tests', () => {
    const creds = Cypress.env('gitlab');

    beforeEach(() => {
        cy.loginToGitlab(creds.root_user, creds.root_password);
    });

    it('should create and delete a project', () => {
        const projectName = `runner-test-project-${Date.now()}`;

        // 1. Create Project
        cy.createProject(projectName, creds.root_user);
        cy.get('h1').should('contain', projectName);

        // 2. (Placeholder) Verify Runner / Pipeline would go here
        // cy.log('Runner configuration testing would happen here');

        // 3. Delete Project
        cy.deleteProject(projectName, creds.root_user);

        // 4. Verify deletion (polling because GitLab deletion is async/status 202)
        const bootstrap = Cypress.env('bootstrap');

        const verifyDeletion = (attempts = 0) => {
            if (attempts > 10) {
                throw new Error(`Project ${projectName} failed to delete within the timeout.`);
            }

            cy.visit(bootstrap.gitlab.url);
            cy.wait(2000); // Give GitLab a second to update the index

            cy.get('body').then(($body) => {
                if ($body.text().includes(projectName)) {
                    cy.log(`Project still visible, retrying deletion check (${attempts + 1}/10)...`);
                    cy.wait(3000);
                    verifyDeletion(attempts + 1);
                } else {
                    cy.log('Project successfully deleted.');
                }
            });
        };

        verifyDeletion();
    });
});
