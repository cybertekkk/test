describe('GitLab Authentication Tests', () => {

    it('should login successfully as root and verify via API', () => {
        const creds = Cypress.env('gitlab');
        const bootstrap = Cypress.env('bootstrap');

        cy.loginToGitlab(creds.root_user, creds.root_password);

        // API verification is session-based. The request will use cookies from loginToGitlab.
        cy.request(`${bootstrap.gitlab.url}/api/v4/user`).then((response) => {
            expect(response.status).to.eq(200);
            cy.log(`API response username: ${response.body.username}`);
            expect(response.body.username.toLowerCase()).to.eq(creds.root_user.toLowerCase());
        });

        cy.logoutFromGitlab();
    });

    it('should login successfully as normal user and verify via API', () => {
        const creds = Cypress.env('gitlab');
        const bootstrap = Cypress.env('bootstrap');

        if (creds.normal_user) {
            cy.loginToGitlab(creds.normal_user, creds.normal_password);

            cy.request(`${bootstrap.gitlab.url}/api/v4/user`).then((response) => {
                expect(response.status).to.eq(200);
                cy.log(`API response username: ${response.body.username}`);
                // Use toLowerCase() to be version/config agnostic on matching
                expect(response.body.username.toLowerCase()).to.eq(creds.normal_user.toLowerCase());
            });

            cy.logoutFromGitlab();
        } else {
            cy.log('Normal user not defined in env, skipping');
        }
    });
});
