describe('GitLab Project Lifecycle Tests', () => {
    const creds = Cypress.env('gitlab');

    beforeEach(() => {
        cy.loginToGitlab(creds.root_user, creds.root_password);
    });

    it('should create and delete a project', () => {
        const projectName = `runner-test-project-${Date.now()}`;

        // 1. Create Project
        cy.createProject(projectName, creds.root_user);
        cy.get('h1').should('contain', projectName);

        // 2. (Placeholder) Verify Runner / Pipeline would go here
        // cy.log('Runner configuration testing would happen here');

        // 3. Delete Project
        cy.deleteProject(projectName, creds.root_user);

        // 4. Verify deletion (API-based check is best for EE v18.5 to avoid Activity feed noise)
        const bootstrap = Cypress.env('bootstrap');
        const projectPath = encodeURIComponent(`${creds.root_user}/${projectName}`);
        const apiUrl = `${bootstrap.gitlab.url}/api/v4/projects/${projectPath}`;

        const verifyDeletion = (attempts = 0) => {
            if (attempts > 12) {
                throw new Error(`Project ${projectName} still exists via API after timeout.`);
            }

            // We use cy.request to check if the project actually exists in the DB
            cy.request({
                method: 'GET',
                url: apiUrl,
                failOnStatusCode: false
            }).then((response) => {
                if (response.status === 200) {
                    cy.log(`Project still exists in API (Attempt ${attempts + 1}/12). waiting...`);
                    cy.wait(5000);
                    verifyDeletion(attempts + 1);
                } else if (response.status === 404) {
                    cy.log('Confirmed: Project is gone (404 Not Found from API).');
                } else {
                    cy.log(`Unexpected status: ${response.status}. Retrying...`);
                    cy.wait(5000);
                    verifyDeletion(attempts + 1);
                }
            });
        };

        verifyDeletion();
    });
});
