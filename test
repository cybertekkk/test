describe('GitLab Access Tests', () => {

    it('should verify GitLab is accessible via API (Health Check)', () => {
        const bootstrap = Cypress.env('bootstrap');
        cy.request(`${bootstrap.gitlab.url}/-/health`).then((response) => {
            expect(response.status).to.eq(200);
            expect(response.body).to.contain('GitLab OK');
        });
    });

    it('should verify GitLab UI is accessible', () => {
        const bootstrap = Cypress.env('bootstrap');
        cy.visit(bootstrap.gitlab.url);
        cy.get('body').should('be.visible');
    });

    const pages = ['/explore', '/help'];
    pages.forEach((page) => {
        it(`should verify UI access to ${page}`, () => {
            cy.visit(page);
            cy.get('body').should('be.visible');
        });
    });
});


--auth

describe('GitLab Authentication Tests', () => {
    const creds = Cypress.env('gitlab');
    const bootstrap = Cypress.env('bootstrap');

    it('should login successfully as root and verify via API', () => {
        cy.loginToGitlab(creds.root_user, creds.root_password);

        // Use API to verify session is active
        cy.request(`${bootstrap.gitlab.url}/api/v4/user`).then((response) => {
            expect(response.status).to.eq(200);
            expect(response.body.username).to.eq(creds.root_user);
        });

        cy.logoutFromGitlab();
    });

    it('should login successfully as normal user and verify via API', () => {
        if (creds.normal_user) {
            cy.loginToGitlab(creds.normal_user, creds.normal_password);

            // Use API to verify session is active
            cy.request(`${bootstrap.gitlab.url}/api/v4/user`).then((response) => {
                expect(response.status).to.eq(200);
                expect(response.body.username).to.eq(creds.normal_user);
            });

            cy.logoutFromGitlab();
        } else {
            cy.log('Normal user not defined in env, skipping');
        }
    });
});


--project


describe('GitLab Project Lifecycle Tests', () => {

    it('should create and delete a project', () => {
        const creds = Cypress.env('gitlab');
        const projectName = `runner-test-project-${Date.now()}`;

        cy.loginToGitlab(creds.root_user, creds.root_password);

        // 1. Create Project
        cy.createProject(projectName, creds.root_user);
        cy.get('h1').should('contain', projectName);

        // 2. (Placeholder) Verify Runner / Pipeline would go here
        // cy.log('Runner configuration testing would happen here');

        // 3. Delete Project
        cy.deleteProject(projectName, creds.root_user);

        // 4. Verify deletion (API-based check is best for EE v18.5 to avoid Activity feed noise)
        const bootstrap = Cypress.env('bootstrap');
        const projectPath = encodeURIComponent(`${creds.root_user}/${projectName}`);
        const apiUrl = `${bootstrap.gitlab.url}/api/v4/projects/${projectPath}`;

        const verifyDeletion = (attempts = 0) => {
            if (attempts > 12) {
                throw new Error(`Project ${projectName} still exists via API after timeout.`);
            }

            // We use cy.request to check if the project actually exists in the DB
            cy.request({
                method: 'GET',
                url: apiUrl,
                failOnStatusCode: false
            }).then((response) => {
                if (response.status === 200) {
                    cy.log(`Project still exists in API (Attempt ${attempts + 1}/12). waiting...`);
                    cy.wait(5000);
                    verifyDeletion(attempts + 1);
                } else if (response.status === 404) {
                    cy.log('Confirmed: Project is gone (404 Not Found from API).');
                } else {
                    cy.log(`Unexpected status: ${response.status}. Retrying...`);
                    cy.wait(5000);
                    verifyDeletion(attempts + 1);
                }
            });
        };

        verifyDeletion();
    });
});


--runner
describe('GitLab Runner Verification', () => {

    it('should successfully run a CI/CD pipeline on the RKE2 cluster runner', () => {
        const bootstrap = Cypress.env('bootstrap');
        const creds = Cypress.env('gitlab');
        const timestamp = Date.now();
        const projectName = `runner-verify-${timestamp}`;

        cy.loginToGitlab(creds.root_user, creds.root_password);

        // 1. Create a project
        cy.createProject(projectName, creds.root_user);

        // 2. Create a feature branch
        const branchName = 'feature/test-runner';
        cy.createBranch(projectName, branchName, creds.root_user);

        // 3. Add a .gitlab-ci.yml file to trigger a pipeline on the feature branch
        const ciContent = `
hello-world-job:
  stage: test
  tags:
    - rke2
  script:
    - echo "GitLab Runner handles the job successfully!"
    - hostname
    - date
`;
        cy.createFile(projectName, '.gitlab-ci.yml', ciContent, creds.root_user, branchName);

        // Give GitLab a moment to register the commit and start the pipeline
        cy.wait(5000);

        // 3. Poll Pipeline Status via API for reliability (Version Agnostic)
        const projectPathEncoded = encodeURIComponent(`${creds.root_user}/${projectName}`);
        const apiBaseUrl = `${bootstrap.gitlab.url}/api/v4`;

        // Wait up to 3 minutes, polling every 10 seconds
        function checkPipeline(attempts = 0) {
            if (attempts > 18) {
                // Cleanup before failing
                cy.deleteProject(projectName, creds.root_user);
                throw new Error('Pipeline timed out or never started.');
            }

            cy.get('meta[name="csrf-token"]').first().then(($meta) => {
                const csrfToken = $meta.attr('content');

                cy.request({
                    method: 'GET',
                    url: `${apiBaseUrl}/projects/${projectPathEncoded}/pipelines`,
                    headers: { 'X-CSRF-Token': csrfToken }
                }).then((resp) => {
                    const pipelines = resp.body;
                    if (pipelines.length === 0) {
                        cy.log('No pipeline found yet, waiting...');
                        cy.wait(10000);
                        checkPipeline(attempts + 1);
                    } else {
                        const status = pipelines[0].status;
                        cy.log(`Pipeline found. Current status: ${status}`);

                        if (status === 'success') {
                            cy.log('Confirmed: Pipeline Passed via API!');
                            // Optional: Cleanup
                            cy.deleteProject(projectName, creds.root_user);
                        } else if (status === 'failed' || status === 'canceled') {
                            // Cleanup before failing
                            cy.deleteProject(projectName, creds.root_user);
                            throw new Error(`Pipeline ended with status: ${status}`);
                        } else {
                            cy.log('Pipeline still running, waiting...');
                            cy.wait(10000);
                            checkPipeline(attempts + 1);
                        }
                    }
                });
            });
        }

        checkPipeline();
    });
});


--saml

describe('GitLab SAML Authentication', () => {

    beforeEach(() => {
        cy.clearCookies();
        cy.clearLocalStorage();
    });

    it('should successfully log in to GitLab via Keycloak SAML and verify via API', () => {
        const bootstrap = Cypress.env('bootstrap');
        // Retrieve SAML credentials from env or use defaults
        const creds = Cypress.env('gitlab') || {};
        const samlUsername = creds.normal_user || 'saml-user';
        const samlPassword = creds.normal_password || 'SAMLPassword123!';

        // 1. Visit GitLab sign-in page
        cy.visit(`${bootstrap.gitlab.url}/users/sign_in`);

        // 2. Click on the SAML/Keycloak button (Version Agnostic Selectors)
        // We look for a provider button specifically for saml or keycloak
        cy.get('a[data-provider="saml"], a[title*="Keycloak"], a[href*="saml"]').first().click();

        // 3. This should redirect to Keycloak
        cy.url().should('include', `/realms/${bootstrap.domain}/protocol/saml`);

        // 4. Fill in Keycloak login form
        cy.get('#username').type(samlUsername);
        cy.get('#password').type(samlPassword);
        cy.get('#kc-login').click();

        // 5. Should be redirected back to GitLab
        cy.url().should('include', bootstrap.gitlab.url);

        // 6. Verify Session via API (The ultimate version-agnostic source of truth)
        cy.request(`${bootstrap.gitlab.url}/api/v4/user`).then((response) => {
            expect(response.status).to.eq(200);
            expect(response.body.username).to.eq(samlUsername);
            cy.log(`Successfully logged in as ${response.body.username} via SAML`);
        });
    });
});
